<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8"/>
    <title>StackProtectorDescriptor</title>
        <link rel="stylesheet" type="text/css" href="../clang-doc-mustache.css"/>
        <script src="../mustache-index.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar__container">
            <div class="navbar__logo">
                
            </div>
            <div class="navbar__menu">
                <ul class="navbar__links">
                    <li class="navbar__item">
                        <a href="../index.html" class="navbar__link">Home</a>
                    </li>
                </ul>
            </div>
            <div class="navbar-breadcrumb-container">
                <div class="navbar-breadcrumb-item"><a href="../GlobalNamespace/index.html">Global Namespace</a></div>&rarr;
                <div class="navbar-breadcrumb-item"><a href="./index.html">llvm</a></div>
            </div>
        </div>
    </nav>
    <main>
        <div class="container">
            <div class="sidebar">
                <h2>class StackProtectorDescriptor</h2>
                <ul>
                    <li class="sidebar-section">
                        <a class="sidebar-item" href="#PublicMethods">Public Method</a>
                    </li>
                    <li>
                        <ul>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#B5962E8A83CB766022FE0D0CD1E6FAC4B96011ED">StackProtectorDescriptor</a>
                            </li>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#8F5116755D250C6D425A7C387FEA4C3F4FADA878">shouldEmitStackProtector</a>
                            </li>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#C9BA2C83D7AE4D34E9A3E7D26F52575609C11A2B">shouldEmitFunctionBasedCheckStackProtector</a>
                            </li>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#0F86D558192E719EE9E9488755DE9C0E29070448">initialize</a>
                            </li>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#F32CD3780D3FA08570CB7F4F5EA06A31D8D07250">resetPerBBState</a>
                            </li>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#1B2E367C6DF81A5FF1E4143D454BDCABA463E582">resetPerFunctionState</a>
                            </li>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#059C3E78E093C8B9A9217CE02573E5DA0A8BD1AB">getParentMBB</a>
                            </li>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#566383429BB6BAAA0B0777E57405689C825EB5C5">getSuccessMBB</a>
                            </li>
                            <li class="sidebar-item-container">
                                <a class="sidebar-item" href="#5A37AF9B644453C76A1E673F5A912AB4F1FDD1D0">getFailureMBB</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="resizer" id="resizer"></div>
            <div class="content">
                <section class="hero section-container">
                    <div class="hero__title">
                        <h1 class="hero__title-large">class StackProtectorDescriptor</h1>
                        <p>Defined at line 116 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                        <div class="hero__subtitle">
                            <div>
                                <p> Encapsulates all of the information needed to generate a stack protector</p>
                                <p> check, and signals to isel when initialized that one needs to be generated.</p>
                            </div>
                            <div>
                                <p> *NOTE* The following is a high level documentation of SelectionDAG Stack</p>
                                <p> Protector Generation. This is now also ported be shared with GlobalISel,</p>
                                <p> but without any significant changes.</p>
                            </div>
                            <div>
                                <p> High Level Overview of ISel Stack Protector Generation:</p>
                            </div>
                            <div>
                                <p> Previously, the &quot;stack protector&quot; IR pass handled stack protector</p>
                                <p> generation. This necessitated splitting basic blocks at the IR level to</p>
                                <p> create the success/failure basic blocks in the tail of the basic block in</p>
                                <p> question. As a result of this, calls that would have qualified for the</p>
                                <p> sibling call optimization were no longer eligible for optimization since</p>
                                <p> said calls were no longer right in the &quot;tail position&quot; (i.e. the immediate</p>
                                <p> predecessor of a ReturnInst instruction).</p>
                            </div>
                            <div>
                                <p> Since the sibling call optimization causes the callee to reuse the caller&#39;s</p>
                                <p> stack, if we could delay the generation of the stack protector check until</p>
                                <p> later in CodeGen after the sibling call decision was made, we get both the</p>
                                <p> tail call optimization and the stack protector check!</p>
                            </div>
                            <div>
                                <p> A few goals in solving this problem were:</p>
                            </div>
                            <div>
                                <p>   1. Preserve the architecture independence of stack protector generation.</p>
                            </div>
                            <div>
                                <p>   2. Preserve the normal IR level stack protector check for platforms like</p>
                                <p>      OpenBSD for which we support platform-specific stack protector</p>
                                <p>      generation.</p>
                            </div>
                            <div>
                                <p> The main problem that guided the present solution is that one can not</p>
                                <p> solve this problem in an architecture independent manner at the IR level</p>
                                <p> only. This is because:</p>
                            </div>
                            <div>
                                <p>   1. The decision on whether or not to perform a sibling call on certain</p>
                                <p>      platforms (for instance i386) requires lower level information</p>
                                <p>      related to available registers that can not be known at the IR level.</p>
                            </div>
                            <div>
                                <p>   2. Even if the previous point were not true, the decision on whether to</p>
                                <p>      perform a tail call is done in LowerCallTo in SelectionDAG (or</p>
                                <p>      CallLowering in GlobalISel) which occurs after the Stack Protector</p>
                                <p>      Pass. As a result, one would need to put the relevant callinst into the</p>
                                <p>      stack protector check success basic block (where the return inst is</p>
                                <p>      placed) and then move it back later at ISel/MI time before the</p>
                                <p>      stack protector check if the tail call optimization failed. The MI</p>
                                <p>      level option was nixed immediately since it would require</p>
                                <p>      platform-specific pattern matching. The ISel level option was</p>
                                <p>      nixed because SelectionDAG only processes one IR level basic block at a</p>
                                <p>      time implying one could not create a DAG Combine to move the callinst.</p>
                            </div>
                            <div>
                                <p> To get around this problem:</p>
                            </div>
                            <div>
                                <p>   1. SelectionDAG can only process one block at a time, we can generate</p>
                                <p>      multiple machine basic blocks for one IR level basic block.</p>
                                <p>      This is how we handle bit tests and switches.</p>
                            </div>
                            <div>
                                <p>   2. At the MI level, tail calls are represented via a special return</p>
                                <p>      MIInst called &quot;tcreturn&quot;. Thus if we know the basic block in which we</p>
                                <p>      wish to insert the stack protector check, we get the correct behavior</p>
                                <p>      by always inserting the stack protector check right before the return</p>
                                <p>      statement. This is a &quot;magical transformation&quot; since no matter where</p>
                                <p>      the stack protector check intrinsic is, we always insert the stack</p>
                                <p>      protector check code at the end of the BB.</p>
                            </div>
                            <div>
                                <p> Given the aforementioned constraints, the following solution was devised:</p>
                            </div>
                            <div>
                                <p>   1. On platforms that do not support ISel stack protector check</p>
                                <p>      generation, allow for the normal IR level stack protector check</p>
                                <p>      generation to continue.</p>
                            </div>
                            <div>
                                <p>   2. On platforms that do support ISel stack protector check</p>
                                <p>      generation:</p>
                            </div>
                            <div>
                                <p>     a. Use the IR level stack protector pass to decide if a stack</p>
                                <p>        protector is required/which BB we insert the stack protector check</p>
                                <p>        in by reusing the logic already therein.</p>
                            </div>
                            <div>
                                <p>     b. After we finish selecting the basic block, we produce the validation</p>
                                <p>        code with one of these techniques:</p>
                                <p>          1) with a call to a guard check function</p>
                                <p>          2) with inlined instrumentation</p>
                            </div>
                            <div>
                                <p>        1) We insert a call to the check function before the terminator.</p>
                            </div>
                            <div>
                                <p>        2) We first find a splice point in the parent basic block</p>
                                <p>        before the terminator and then splice the terminator of said basic</p>
                                <p>        block into the success basic block. Then we code-gen a new tail for</p>
                                <p>        the parent basic block consisting of the two loads, the comparison,</p>
                                <p>        and finally two branches to the success/failure basic blocks. We</p>
                                <p>        conclude by code-gening the failure basic block if we have not</p>
                                <p>        code-gened it already (all stack protector checks we generate in</p>
                                <p>        the same function, use the same failure basic block).</p>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="PublicMethods" class="section-container">
                    <h2>Public Methods</h2>
                    <div>
                        <div class="delimiter-container">
                            <div id="B5962E8A83CB766022FE0D0CD1E6FAC4B96011ED">
                                <pre><code class="language-cpp code-clang-doc">void StackProtectorDescriptor ()</code></pre>
                                <p>Defined at line 118 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                        <div class="delimiter-container">
                            <div id="8F5116755D250C6D425A7C387FEA4C3F4FADA878">
                                <pre><code class="language-cpp code-clang-doc">bool shouldEmitStackProtector ()</code></pre>
                                <div>
                                    <div>
                                        <p> Returns true if all fields of the stack protector descriptor are</p>
                                        <p> initialized implying that we should/are ready to emit a stack protector.</p>
                                    </div>
                                </div>
                                <p>Defined at line 122 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                        <div class="delimiter-container">
                            <div id="C9BA2C83D7AE4D34E9A3E7D26F52575609C11A2B">
                                <pre><code class="language-cpp code-clang-doc">bool shouldEmitFunctionBasedCheckStackProtector ()</code></pre>
                                <p>Defined at line 126 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                        <div class="delimiter-container">
                            <div id="0F86D558192E719EE9E9488755DE9C0E29070448">
                                <pre><code class="language-cpp code-clang-doc">void initialize (const BasicBlock * BB, MachineBasicBlock * MBB, bool FunctionBasedInstrumentation)</code></pre>
                                <div>
                                    <div>
                                        <p> Initialize the stack protector descriptor structure for a new basic</p>
                                        <p> block.</p>
                                    </div>
                                </div>
                                <p>Defined at line 132 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                        <div class="delimiter-container">
                            <div id="F32CD3780D3FA08570CB7F4F5EA06A31D8D07250">
                                <pre><code class="language-cpp code-clang-doc">void resetPerBBState ()</code></pre>
                                <div>
                                    <div>
                                        <p> Reset state that changes when we handle different basic blocks.</p>
                                    </div>
                                    <div>
                                        <p> This currently includes:</p>
                                    </div>
                                    <div>
                                        <p> 1. The specific basic block we are generating a</p>
                                        <p> stack protector for (ParentMBB).</p>
                                    </div>
                                    <div>
                                        <p> 2. The successor machine basic block that will contain the tail of</p>
                                        <p> parent mbb after we create the stack protector check (SuccessMBB). This</p>
                                        <p> BB is visited only on stack protector check success.</p>
                                    </div>
                                </div>
                                <p>Defined at line 154 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                        <div class="delimiter-container">
                            <div id="1B2E367C6DF81A5FF1E4143D454BDCABA463E582">
                                <pre><code class="language-cpp code-clang-doc">void resetPerFunctionState ()</code></pre>
                                <div>
                                    <div>
                                        <p> Reset state that only changes when we switch functions.</p>
                                    </div>
                                    <div>
                                        <p> This currently includes:</p>
                                    </div>
                                    <div>
                                        <p> 1. FailureMBB since we reuse the failure code path for all stack</p>
                                        <p> protector checks created in an individual function.</p>
                                    </div>
                                    <div>
                                        <p> 2.The guard variable since the guard variable we are checking against is</p>
                                        <p> always the same.</p>
                                    </div>
                                </div>
                                <p>Defined at line 168 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                        <div class="delimiter-container">
                            <div id="059C3E78E093C8B9A9217CE02573E5DA0A8BD1AB">
                                <pre><code class="language-cpp code-clang-doc">MachineBasicBlock * getParentMBB ()</code></pre>
                                <p>Defined at line 170 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                        <div class="delimiter-container">
                            <div id="566383429BB6BAAA0B0777E57405689C825EB5C5">
                                <pre><code class="language-cpp code-clang-doc">MachineBasicBlock * getSuccessMBB ()</code></pre>
                                <p>Defined at line 171 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                        <div class="delimiter-container">
                            <div id="5A37AF9B644453C76A1E673F5A912AB4F1FDD1D0">
                                <pre><code class="language-cpp code-clang-doc">MachineBasicBlock * getFailureMBB ()</code></pre>
                                <p>Defined at line 172 of file llvm/include/llvm/CodeGen/CodeGenCommonISel.h</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>
</body>
</html>
